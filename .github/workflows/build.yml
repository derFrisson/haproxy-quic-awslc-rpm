name: Build HAProxy QUIC RPM (AWS-LC)

on:
  workflow_call:
    inputs:
      haproxy_version:
        required: true
        type: string
      awslc_version:
        required: true
        type: string
    # Note: GITHUB_TOKEN is automatically available to called workflows
  workflow_dispatch:
    inputs:
      haproxy_version:
        description: 'HAProxy version (check haproxy.org for latest)'
        required: true
      awslc_version:
        description: 'AWS-LC version (check github.com/aws/aws-lc/releases)'
        required: true

env:
  HAPROXY_VERSION: ${{ inputs.haproxy_version }}
  AWSLC_VERSION: ${{ inputs.awslc_version }}

jobs:
  build:
    runs-on: ubuntu-latest
    container: rockylinux/rockylinux:10

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install build dependencies
        run: |
          set -euo pipefail

          dnf install -y epel-release
          dnf config-manager --set-enabled crb
          dnf install -y \
            gcc \
            gcc-c++ \
            make \
            git \
            rpm-build \
            rpmdevtools \
            pcre2-devel \
            systemd-devel \
            lua-devel \
            zlib-devel \
            readline-devel \
            perl \
            tar \
            wget \
            jq \
            cmake \
            ninja-build \
            golang \
            ca-certificates

      - name: Setup RPM build tree
        run: |
          rpmdev-setuptree
          echo "RPM build tree created at $HOME/rpmbuild"

      - name: Download and verify sources
        run: |
          set -euo pipefail

          cd ~/rpmbuild/SOURCES

          # Determine HAProxy minor version for download URL (e.g., 3.3.1 -> 3.3)
          HAPROXY_MINOR=$(echo "${HAPROXY_VERSION}" | grep -oP '^\d+\.\d+')

          echo "==========================================="
          echo "Downloading sources"
          echo "==========================================="

          # Download AWS-LC
          echo "Downloading AWS-LC v${AWSLC_VERSION}..."
          wget -q --retry-connrefused --waitretry=5 --timeout=60 \
            "https://github.com/aws/aws-lc/archive/refs/tags/v${AWSLC_VERSION}.tar.gz" \
            -O "aws-lc-${AWSLC_VERSION}.tar.gz"

          # Download HAProxy and its SHA256 checksum
          echo "Downloading HAProxy ${HAPROXY_VERSION}..."
          wget -q --retry-connrefused --waitretry=5 --timeout=60 \
            "https://www.haproxy.org/download/${HAPROXY_MINOR}/src/haproxy-${HAPROXY_VERSION}.tar.gz"

          # Try to download and verify SHA256 checksum if available
          echo "Verifying HAProxy checksum..."
          if wget -q --timeout=30 \
            "https://www.haproxy.org/download/${HAPROXY_MINOR}/src/haproxy-${HAPROXY_VERSION}.tar.gz.sha256" 2>/dev/null; then
            echo "SHA256 checksum file found, verifying..."
            sha256sum -c "haproxy-${HAPROXY_VERSION}.tar.gz.sha256"
            echo "✓ HAProxy checksum verified"
          else
            echo "::warning::SHA256 checksum file not available for HAProxy ${HAPROXY_VERSION}"
            echo "Calculating checksum for reference:"
            sha256sum "haproxy-${HAPROXY_VERSION}.tar.gz"
          fi

          # Verify downloads are valid archives
          echo ""
          echo "Verifying archive integrity..."
          tar tzf "aws-lc-${AWSLC_VERSION}.tar.gz" > /dev/null
          echo "✓ AWS-LC archive valid"
          tar tzf "haproxy-${HAPROXY_VERSION}.tar.gz" > /dev/null
          echo "✓ HAProxy archive valid"

          ls -la

      - name: Copy additional sources
        run: |
          cp SOURCES/* ~/rpmbuild/SOURCES/

      - name: Build AWS-LC
        run: |
          set -euo pipefail

          echo "==========================================="
          echo "Building AWS-LC v${AWSLC_VERSION}"
          echo "==========================================="

          cd ~/rpmbuild/SOURCES
          tar xzf aws-lc-${AWSLC_VERSION}.tar.gz
          cd aws-lc-${AWSLC_VERSION}

          # Build AWS-LC
          mkdir -p build && cd build

          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/opt/haproxy-ssl \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_TESTING=OFF \
            ..

          ninja -j$(nproc)
          DESTDIR=/tmp/awslc-install ninja install

          echo "AWS-LC build complete"
          ls -la /tmp/awslc-install/opt/haproxy-ssl/lib*/

          # Create symlink for lib64 -> lib if needed (HAProxy expects 'lib')
          if [ -d "/tmp/awslc-install/opt/haproxy-ssl/lib64" ] && [ ! -d "/tmp/awslc-install/opt/haproxy-ssl/lib" ]; then
            ln -s lib64 /tmp/awslc-install/opt/haproxy-ssl/lib
          fi

      - name: Build HAProxy
        run: |
          set -euo pipefail

          echo "==========================================="
          echo "Building HAProxy ${HAPROXY_VERSION} with AWS-LC (QUIC support)"
          echo "==========================================="

          cd ~/rpmbuild/SOURCES
          tar xzf haproxy-${HAPROXY_VERSION}.tar.gz
          cd haproxy-${HAPROXY_VERSION}

          # Determine the lib directory
          if [ -d "/tmp/awslc-install/opt/haproxy-ssl/lib64" ]; then
            SSL_LIB_DIR="/tmp/awslc-install/opt/haproxy-ssl/lib64"
            RPATH_DIR="/opt/haproxy-ssl/lib64"
          else
            SSL_LIB_DIR="/tmp/awslc-install/opt/haproxy-ssl/lib"
            RPATH_DIR="/opt/haproxy-ssl/lib"
          fi

          make -j$(nproc) \
            TARGET=linux-glibc \
            USE_LUA=1 \
            USE_PCRE2=1 \
            USE_ZLIB=1 \
            USE_SYSTEMD=1 \
            USE_PROMEX=1 \
            USE_QUIC=1 \
            USE_OPENSSL=1 \
            USE_OPENSSL_AWSLC=1 \
            SSL_INC=/tmp/awslc-install/opt/haproxy-ssl/include \
            SSL_LIB=${SSL_LIB_DIR} \
            LDFLAGS="-Wl,-rpath,${RPATH_DIR}"

          make install DESTDIR=/tmp/haproxy-install PREFIX=/usr

          echo "HAProxy build complete"

      - name: Verify build
        run: |
          set -euo pipefail

          echo "==========================================="
          echo "Verifying HAProxy build"
          echo "==========================================="

          # Determine the lib directory
          if [ -d "/tmp/awslc-install/opt/haproxy-ssl/lib64" ]; then
            SSL_LIB_DIR="/tmp/awslc-install/opt/haproxy-ssl/lib64"
          else
            SSL_LIB_DIR="/tmp/awslc-install/opt/haproxy-ssl/lib"
          fi

          # Get version info
          echo "HAProxy version info:"
          LD_LIBRARY_PATH=${SSL_LIB_DIR} /tmp/haproxy-install/usr/sbin/haproxy -vv

          # Verify QUIC support is present
          echo ""
          echo "Checking for QUIC support..."
          if LD_LIBRARY_PATH=${SSL_LIB_DIR} /tmp/haproxy-install/usr/sbin/haproxy -vv | grep -q "QUIC"; then
            echo "✓ QUIC support verified"
          else
            echo "::error::HAProxy built without QUIC support!"
            exit 1
          fi

          # Verify AWS-LC is being used
          echo ""
          echo "Checking for AWS-LC..."
          if LD_LIBRARY_PATH=${SSL_LIB_DIR} /tmp/haproxy-install/usr/sbin/haproxy -vv | grep -qE "(AWS-LC|aws-lc)"; then
            echo "✓ AWS-LC verified"
          else
            echo "::warning::Could not confirm AWS-LC in version string (may be shown as OpenSSL compatible)"
          fi

          # Verify Prometheus exporter
          echo ""
          echo "Checking for Prometheus exporter..."
          if LD_LIBRARY_PATH=${SSL_LIB_DIR} /tmp/haproxy-install/usr/sbin/haproxy -vv | grep -q "PROMEX"; then
            echo "✓ Prometheus exporter verified"
          else
            echo "::error::HAProxy built without Prometheus exporter!"
            exit 1
          fi

          echo ""
          echo "All build verifications passed!"

      - name: Create RPM staging structure
        run: |
          set -euo pipefail

          echo "==========================================="
          echo "Creating RPM staging structure"
          echo "==========================================="

          # Use staging directory - rpmbuild will copy to BUILDROOT via %install
          STAGING_DIR=/tmp/haproxy-staging
          mkdir -p ${STAGING_DIR}

          # Copy AWS-LC
          cp -a /tmp/awslc-install/* ${STAGING_DIR}/

          # Copy HAProxy
          cp -a /tmp/haproxy-install/* ${STAGING_DIR}/

          # Create required directories
          mkdir -p ${STAGING_DIR}/etc/haproxy/conf.d
          mkdir -p ${STAGING_DIR}/var/lib/haproxy
          mkdir -p ${STAGING_DIR}/usr/lib/systemd/system

          # Copy systemd service
          cp ~/rpmbuild/SOURCES/haproxy.service ${STAGING_DIR}/usr/lib/systemd/system/

          echo "Staging structure:"
          find ${STAGING_DIR} -type f | head -30 || true

      - name: Copy spec file
        run: |
          cp SPECS/haproxy.spec ~/rpmbuild/SPECS/

      - name: Build RPM
        run: |
          set -euo pipefail

          echo "==========================================="
          echo "Building RPM package"
          echo "==========================================="

          # Get current date for changelog
          BUILD_DATE=$(date "+%a %b %d %Y")

          # QA_RPATHS: Allow non-standard RPATH for bundled AWS-LC in /opt
          # 0x0001 = standard paths, 0x0002 = non-standard paths (like /opt), 0x0010 = empty
          QA_RPATHS=$((0x0001|0x0002|0x0010)) rpmbuild -bb ~/rpmbuild/SPECS/haproxy.spec \
            --define "_topdir $HOME/rpmbuild" \
            --define "haproxy_version ${HAPROXY_VERSION}" \
            --define "awslc_version ${AWSLC_VERSION}" \
            --define "build_date ${BUILD_DATE}"

          echo ""
          echo "Built packages:"
          ls -la ~/rpmbuild/RPMS/x86_64/

      - name: Prepare artifacts
        id: artifacts
        run: |
          mkdir -p ./artifacts
          cp ~/rpmbuild/RPMS/x86_64/*.rpm ./artifacts/
          echo "artifact_dir=./artifacts" >> $GITHUB_OUTPUT
          ls -la ./artifacts/

      - name: Upload RPM artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: haproxy-quic-${{ env.HAPROXY_VERSION }}-awslc${{ env.AWSLC_VERSION }}-el10
          path: ./artifacts/*.rpm
          retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download RPM artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          name: haproxy-quic-${{ inputs.haproxy_version }}-awslc${{ inputs.awslc_version }}-el10
          path: ./rpms

      - name: List downloaded files
        run: |
          echo "Downloaded artifacts:"
          ls -la ./rpms/

      - name: Update versions.json
        run: |
          set -euo pipefail

          # Update versions.json with new versions and timestamp
          jq --arg hv "${{ inputs.haproxy_version }}" \
             --arg av "${{ inputs.awslc_version }}" \
             --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '.haproxy.current = $hv | .awslc.current = $av | .last_updated = $ts' \
            versions.json > versions.json.tmp
          mv versions.json.tmp versions.json

          echo "Updated versions.json:"
          cat versions.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions.json

          # Handle potential race condition with fetch/rebase
          git fetch origin main
          git rebase origin/main || {
            echo "::warning::Rebase failed, forcing update"
            git rebase --abort || true
            git add versions.json
          }

          git commit -m "Release HAProxy ${{ inputs.haproxy_version }} + AWS-LC ${{ inputs.awslc_version }}" || echo "No changes to commit"
          git push || {
            echo "::warning::Push failed, retrying with pull"
            git pull --rebase origin main
            git push
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631  # v2.2.2
        with:
          tag_name: haproxy-${{ inputs.haproxy_version }}-awslc${{ inputs.awslc_version }}
          name: HAProxy ${{ inputs.haproxy_version }} + AWS-LC ${{ inputs.awslc_version }}
          body: |
            ## HAProxy with QUIC/HTTP3 Support (AWS-LC)

            | Component | Version |
            |-----------|---------|
            | HAProxy | ${{ inputs.haproxy_version }} |
            | AWS-LC | ${{ inputs.awslc_version }} |
            | Target OS | Rocky Linux 10 / RHEL 10 / AlmaLinux 10 |

            ### Why AWS-LC instead of OpenSSL?

            Based on [HAProxy's SSL Stack Analysis](https://www.haproxy.com/blog/state-of-ssl-stacks):

            - **~50% faster** than OpenSSL 1.1.1 for TLS resumption
            - **6-9x faster** than OpenSSL 3.x in multi-threaded scenarios
            - **Native QUIC support** via BoringSSL-compatible API
            - **Linear scalability** across all CPU cores (no lock contention)
            - **FIPS-capable** (separate FIPS branches available)

            ### Features
            - ✅ Native QUIC/HTTP3 support
            - ✅ Prometheus exporter (`/metrics`)
            - ✅ Lua scripting
            - ✅ PCRE2 regex
            - ✅ zlib compression
            - ✅ systemd integration
            - ✅ Optimized for multi-threaded performance

            ### Installation

            ```bash
            # Download and install
            curl -LO https://github.com/${{ github.repository }}/releases/download/haproxy-${{ inputs.haproxy_version }}-awslc${{ inputs.awslc_version }}/haproxy-quic-${{ inputs.haproxy_version }}-1.el10.x86_64.rpm
            sudo dnf localinstall -y haproxy-quic-*.rpm

            # Verify QUIC support
            haproxy -vv | grep QUIC

            # Start service
            sudo systemctl enable --now haproxy
            ```

            ### Firewall (for QUIC/HTTP3)

            ```bash
            sudo firewall-cmd --permanent --add-port=443/udp
            sudo firewall-cmd --reload
            ```

            ### Performance Notes

            This build uses AWS-LC which provides exceptional multi-threaded performance with linear
            scalability across all CPU cores. Modern compilers ensure optimal performance without
            lock contention.

            ### Changelog
            - [HAProxy Release Notes](https://www.haproxy.org/download/)
            - [AWS-LC ${{ inputs.awslc_version }} Release Notes](https://github.com/aws/aws-lc/releases/tag/v${{ inputs.awslc_version }})
          files: ./rpms/*.rpm
          draft: false
          prerelease: false
