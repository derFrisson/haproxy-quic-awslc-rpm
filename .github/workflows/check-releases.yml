name: Check for New Releases

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  check-releases:
    runs-on: ubuntu-latest
    outputs:
      haproxy_new: ${{ steps.check.outputs.haproxy_new }}
      haproxy_version: ${{ steps.check.outputs.haproxy_version }}
      awslc_new: ${{ steps.check.outputs.awslc_new }}
      awslc_version: ${{ steps.check.outputs.awslc_version }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Check for new releases
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "Checking for new releases..."

          # Get current versions from versions.json
          CURRENT_HAPROXY=$(jq -r '.haproxy.current' versions.json)
          CURRENT_AWSLC=$(jq -r '.awslc.current' versions.json)

          echo "Current versions:"
          echo "  HAProxy: ${CURRENT_HAPROXY}"
          echo "  AWS-LC: ${CURRENT_AWSLC}"

          # ===== Check HAProxy =====
          echo ""
          echo "Checking HAProxy releases..."

          # Dynamically discover available branches from haproxy.org
          echo "  Discovering available branches..."
          BRANCHES=$(curl -sfS --retry 3 --retry-delay 5 --max-time 30 \
            "https://www.haproxy.org/download/" | \
            grep -oP 'href="\K[0-9]+\.[0-9]+(?=/")' | \
            sort -Vr || true)

          if [ -z "$BRANCHES" ]; then
            echo "::error::Failed to discover HAProxy branches from haproxy.org"
            exit 1
          fi

          echo "  Found branches: $(echo $BRANCHES | tr '\n' ' ')"

          # Find the latest stable release across all branches (newest first)
          LATEST_HAPROXY=""
          for MINOR in $BRANCHES; do
            echo "  Checking branch ${MINOR}..."

            # List stable versions in this branch (exclude -dev releases)
            VERSIONS=$(curl -sfS --retry 3 --retry-delay 5 --max-time 30 \
              "https://www.haproxy.org/download/${MINOR}/src/" 2>/dev/null | \
              grep -oP 'haproxy-\K[0-9]+\.[0-9]+\.[0-9]+(?=\.tar\.gz)' | \
              grep -v dev | \
              sort -V | tail -1 || true)

            if [ -n "$VERSIONS" ]; then
              LATEST_HAPROXY=$VERSIONS
              echo "  Found stable release: ${LATEST_HAPROXY}"
              break
            else
              echo "  No stable releases in branch ${MINOR}, trying next..."
            fi
          done

          if [ -z "$LATEST_HAPROXY" ]; then
            echo "::error::Failed to determine latest HAProxy version from any branch"
            exit 1
          fi

          # ===== Check AWS-LC =====
          echo ""
          echo "Checking AWS-LC releases..."

          # Get releases and filter for standard versions only (exclude FIPS releases)
          # Use authenticated request to avoid rate limiting
          AWSLC_RESPONSE=$(curl -sfS --retry 3 --retry-delay 5 --max-time 30 \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/aws/aws-lc/releases?per_page=20")

          # Filter for standard releases: tags matching ^v[0-9]+\.[0-9]+\.[0-9]+$
          # This excludes FIPS releases like AWS-LC-FIPS-NETOS-v1.29.1 or AWS-LC-FIPS-3.1.0
          LATEST_AWSLC=$(echo "$AWSLC_RESPONSE" | \
            jq -r '[.[] | select(.tag_name | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))] | .[0].tag_name // empty' | \
            sed 's/^v//')

          if [ -z "$LATEST_AWSLC" ]; then
            echo "::error::Failed to determine latest AWS-LC version from GitHub API"
            echo "API Response (first release): $(echo "$AWSLC_RESPONSE" | jq -r '.[0] // "empty"')"
            exit 1
          fi

          echo "Latest AWS-LC (standard release): ${LATEST_AWSLC}"

          # ===== Compare versions =====
          echo ""
          echo "Version comparison:"
          echo "  HAProxy: ${CURRENT_HAPROXY} -> ${LATEST_HAPROXY}"
          echo "  AWS-LC:  ${CURRENT_AWSLC} -> ${LATEST_AWSLC}"

          # Check if updates are needed
          HAPROXY_NEW="false"
          AWSLC_NEW="false"

          if [ "$CURRENT_HAPROXY" != "$LATEST_HAPROXY" ]; then
            echo "  -> HAProxy update available!"
            HAPROXY_NEW="true"
          fi

          if [ "$CURRENT_AWSLC" != "$LATEST_AWSLC" ]; then
            echo "  -> AWS-LC update available!"
            AWSLC_NEW="true"
          fi

          # Set outputs
          echo "haproxy_new=${HAPROXY_NEW}" >> $GITHUB_OUTPUT
          echo "haproxy_version=${LATEST_HAPROXY}" >> $GITHUB_OUTPUT
          echo "awslc_new=${AWSLC_NEW}" >> $GITHUB_OUTPUT
          echo "awslc_version=${LATEST_AWSLC}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Release Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Current | Latest | Update? |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| HAProxy | $(jq -r '.haproxy.current' versions.json) | ${{ steps.check.outputs.haproxy_version }} | ${{ steps.check.outputs.haproxy_new }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS-LC | $(jq -r '.awslc.current' versions.json) | ${{ steps.check.outputs.awslc_version }} | ${{ steps.check.outputs.awslc_new }} |" >> $GITHUB_STEP_SUMMARY

  trigger-build:
    needs: check-releases
    if: needs.check-releases.outputs.haproxy_new == 'true' || needs.check-releases.outputs.awslc_new == 'true'
    uses: ./.github/workflows/build.yml
    with:
      haproxy_version: ${{ needs.check-releases.outputs.haproxy_version }}
      awslc_version: ${{ needs.check-releases.outputs.awslc_version }}
    # GITHUB_TOKEN is automatically available to called workflows
